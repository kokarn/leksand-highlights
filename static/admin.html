<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GamePulse Admin Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-color: #0f172a;
            --panel-bg: rgba(30, 41, 59, 0.8);
            --panel-border: rgba(148, 163, 184, 0.2);
            --accent: #38bdf8;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --danger: #f87171;
            --success: #4ade80;
        }

        body {
            background: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 2.5rem 1.5rem 4rem;
        }

        header {
            max-width: 1200px;
            margin: 0 auto 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        header h1 {
            font-size: 2.4rem;
            font-weight: 700;
        }

        header p {
            color: var(--text-secondary);
            max-width: 680px;
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 1rem;
            padding: 1.5rem;
            backdrop-filter: blur(12px);
        }

        .panel h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }

        .status-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 0.75rem;
            padding: 1rem;
        }

        .status-card h3 {
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            color: var(--accent);
        }

        .status-card dl {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.35rem 0.75rem;
            font-size: 0.85rem;
        }

        .status-card dt {
            color: var(--text-secondary);
        }

        .status-card dd {
            text-align: right;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        button {
            border: none;
            border-radius: 0.6rem;
            padding: 0.65rem 1rem;
            font-weight: 600;
            cursor: pointer;
            background: var(--accent);
            color: #0f172a;
        }

        button.secondary {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-primary);
        }

        button.danger {
            background: var(--danger);
            color: #1f2937;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .feedback {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            white-space: pre-line;
        }

        .feedback.success {
            color: var(--success);
        }

        .feedback.error {
            color: var(--danger);
        }

        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .checkbox-field {
            display: flex;
            align-items: center;
            height: 100%;
        }

        .checkbox-field label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .checkbox-field input {
            margin: 0;
        }

        label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 0.4rem;
        }

        input,
        select {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border-radius: 0.6rem;
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: rgba(15, 23, 42, 0.6);
            color: var(--text-primary);
        }

        .games-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .game-card {
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 0.85rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.6);
        }

        .game-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .game-title {
            font-weight: 600;
        }

        .game-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
        }

        .game-actions {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .muted {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        @media (max-width: 640px) {
            body {
                padding: 1.5rem 1rem 3rem;
            }

            header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>GamePulse Admin Console</h1>
        <p>Manage manual games, monitor caches, and trigger operational tasks across all supported sports.</p>
    </header>

    <main>
        <section class="panel">
            <h2>Operations status</h2>
            <div class="status-grid" id="status-grid"></div>
            <div class="actions" style="margin-top: 1rem;">
                <button id="refresh-status" class="secondary">Refresh status</button>
                <button id="clear-cache">Clear caches</button>
                <button id="run-notifier" class="secondary">Run notifier check</button>
                <button id="refresh-biathlon" class="secondary">Refresh biathlon schedule</button>
            </div>
            <div class="feedback" id="status-feedback"></div>
        </section>

        <section class="panel">
            <h2>Sports coverage</h2>
            <p class="muted">Current sports providers loaded by the API.</p>
            <div class="status-grid" id="sports-grid"></div>
            <div class="actions" style="margin-top: 1rem;">
                <button id="refresh-sports" class="secondary">Refresh sports list</button>
            </div>
            <div class="feedback" id="sports-feedback"></div>
        </section>

        <section class="panel">
            <h2>Push notifications</h2>
            <p class="muted">Goal alerts via OneSignal. Monitors live games and sends notifications when goals are scored.</p>
            <div class="status-grid" id="push-status-grid"></div>
            <div class="actions" style="margin-top: 1rem;">
                <button id="refresh-push-status" class="secondary">Refresh status</button>
                <button id="run-goal-watcher" class="secondary">Run goal check</button>
            </div>
            <div style="margin-top: 1.25rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Test notification</h3>
                <div class="form-grid">
                    <div>
                        <label for="test-push-message">Message (optional)</label>
                        <input id="test-push-message" type="text" placeholder="Custom message for test notification" />
                    </div>
                    <div>
                        <label for="test-push-target-type">Target type</label>
                        <select id="test-push-target-type">
                            <option value="tags">Goal notifications tag</option>
                            <option value="subscription">Subscription ID</option>
                            <option value="player">Player ID (legacy)</option>
                            <option value="external">External user ID</option>
                        </select>
                    </div>
                    <div>
                        <label for="test-push-target-id">Target ID (optional)</label>
                        <input id="test-push-target-id" type="text" placeholder="OneSignal subscription ID" />
                    </div>
                </div>
                <div class="actions" style="margin-top: 0.75rem;">
                    <button id="send-test-push">Send test notification</button>
                </div>
            </div>
            <div style="margin-top: 1.5rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Goal notification test</h3>
                <div class="form-grid">
                    <div>
                        <label for="goal-test-sport">Sport</label>
                        <select id="goal-test-sport">
                            <option value="shl">SHL</option>
                            <option value="allsvenskan">Allsvenskan</option>
                        </select>
                    </div>
                    <div>
                        <label for="goal-test-scoring-team">Scoring team</label>
                        <select id="goal-test-scoring-team"></select>
                    </div>
                    <div>
                        <label for="goal-test-opposing-team">Opposing team</label>
                        <select id="goal-test-opposing-team"></select>
                    </div>
                    <div class="checkbox-field">
                        <label for="goal-test-scoring-home">
                            <input id="goal-test-scoring-home" type="checkbox" checked />
                            Scoring team is home team
                        </label>
                    </div>
                    <div>
                        <label for="goal-test-scorer-name">Scorer name</label>
                        <input id="goal-test-scorer-name" type="text" placeholder="Test Scorer" />
                    </div>
                    <div>
                        <label for="goal-test-home-score">Home score</label>
                        <input id="goal-test-home-score" type="number" min="0" placeholder="1" />
                    </div>
                    <div>
                        <label for="goal-test-away-score">Away score</label>
                        <input id="goal-test-away-score" type="number" min="0" placeholder="0" />
                    </div>
                    <div>
                        <label for="goal-test-period">Period/half</label>
                        <input id="goal-test-period" type="text" placeholder="P1" />
                    </div>
                    <div>
                        <label for="goal-test-time">Time</label>
                        <input id="goal-test-time" type="text" placeholder="12:34" />
                    </div>
                    <div>
                        <label for="goal-test-target-type">Target type</label>
                        <select id="goal-test-target-type">
                            <option value="tags">Team tags</option>
                            <option value="subscription">Subscription ID</option>
                            <option value="player">Player ID (legacy)</option>
                            <option value="external">External user ID</option>
                        </select>
                    </div>
                    <div>
                        <label for="goal-test-target-id">Target ID (optional)</label>
                        <input id="goal-test-target-id" type="text" placeholder="OneSignal subscription ID" />
                    </div>
                    <div class="checkbox-field">
                        <label for="goal-test-send-opposing">
                            <input id="goal-test-send-opposing" type="checkbox" checked />
                            Send opposing notification
                        </label>
                    </div>
                </div>
                <div class="actions" style="margin-top: 0.75rem;">
                    <button id="send-goal-test" class="secondary">Send goal test</button>
                </div>
            </div>
            <div class="feedback" id="push-feedback"></div>
        </section>

        <section class="panel">
            <h2>Create manual game</h2>
            <form id="create-game-form">
                <div>
                    <label for="home-team">Home team</label>
                    <select id="home-team" required></select>
                </div>
                <div>
                    <label for="away-team">Away team</label>
                    <select id="away-team" required></select>
                </div>
                <div>
                    <label for="game-state">State</label>
                    <select id="game-state">
                        <option value="live">Live</option>
                        <option value="pre-game">Pre-game</option>
                        <option value="post-game">Post-game</option>
                    </select>
                </div>
                <div>
                    <label for="start-time">Start time</label>
                    <input id="start-time" type="datetime-local" required />
                </div>
                <div>
                    <label for="venue">Venue</label>
                    <input id="venue" type="text" placeholder="Arena name" />
                </div>
                <div>
                    <label for="home-score">Home score</label>
                    <input id="home-score" type="number" min="0" value="0" />
                </div>
                <div>
                    <label for="away-score">Away score</label>
                    <input id="away-score" type="number" min="0" value="0" />
                </div>
                <button type="submit">Create game</button>
            </form>
            <div class="feedback" id="create-feedback"></div>
        </section>

        <section class="panel">
            <h2>Manual games</h2>
            <p class="muted" id="games-count"></p>
            <div class="games-list" id="games-list"></div>
            <div class="feedback" id="games-feedback"></div>
        </section>
    </main>

    <script>
        const statusGrid = document.getElementById('status-grid');
        const statusFeedback = document.getElementById('status-feedback');
        const sportsGrid = document.getElementById('sports-grid');
        const sportsFeedback = document.getElementById('sports-feedback');
        const createFeedback = document.getElementById('create-feedback');
        const gamesFeedback = document.getElementById('games-feedback');
        const gamesList = document.getElementById('games-list');
        const gamesCount = document.getElementById('games-count');
        const pushStatusGrid = document.getElementById('push-status-grid');
        const pushFeedback = document.getElementById('push-feedback');
        const testPushMessageInput = document.getElementById('test-push-message');
        const testPushTargetType = document.getElementById('test-push-target-type');
        const testPushTargetId = document.getElementById('test-push-target-id');

        const goalTestSport = document.getElementById('goal-test-sport');
        const goalTestScoringTeam = document.getElementById('goal-test-scoring-team');
        const goalTestOpposingTeam = document.getElementById('goal-test-opposing-team');
        const goalTestScoringHome = document.getElementById('goal-test-scoring-home');
        const goalTestScorerName = document.getElementById('goal-test-scorer-name');
        const goalTestHomeScore = document.getElementById('goal-test-home-score');
        const goalTestAwayScore = document.getElementById('goal-test-away-score');
        const goalTestPeriod = document.getElementById('goal-test-period');
        const goalTestTime = document.getElementById('goal-test-time');
        const goalTestTargetType = document.getElementById('goal-test-target-type');
        const goalTestTargetId = document.getElementById('goal-test-target-id');
        const goalTestSendOpposing = document.getElementById('goal-test-send-opposing');

        const homeTeamSelect = document.getElementById('home-team');
        const awayTeamSelect = document.getElementById('away-team');
        const startTimeInput = document.getElementById('start-time');
        const venueInput = document.getElementById('venue');
        const gameStateSelect = document.getElementById('game-state');
        const homeScoreInput = document.getElementById('home-score');
        const awayScoreInput = document.getElementById('away-score');

        const refreshStatusButton = document.getElementById('refresh-status');
        const clearCacheButton = document.getElementById('clear-cache');
        const runNotifierButton = document.getElementById('run-notifier');
        const refreshBiathlonButton = document.getElementById('refresh-biathlon');
        const refreshSportsButton = document.getElementById('refresh-sports');
        const createForm = document.getElementById('create-game-form');
        const refreshPushStatusButton = document.getElementById('refresh-push-status');
        const runGoalWatcherButton = document.getElementById('run-goal-watcher');
        const sendTestPushButton = document.getElementById('send-test-push');
        const sendGoalTestButton = document.getElementById('send-goal-test');

        let teams = [];
        let footballTeams = [];
        let sports = [];
        let venueTouched = false;

        function escapeHtml(value) {
            return String(value === null || value === undefined ? '' : value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function showFeedback(element, message, type) {
            element.textContent = message || '';
            element.className = `feedback ${type || ''}`.trim();
        }

        const SWEDISH_TIMESTAMP_OPTIONS = {
            timeZone: 'Europe/Stockholm',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };

        function formatDuration(seconds) {
            if (seconds === null || seconds === undefined) {
                return '-';
            }
            const total = Math.floor(Number(seconds));
            if (Number.isNaN(total)) {
                return '-';
            }
            const hours = Math.floor(total / 3600);
            const minutes = Math.floor((total % 3600) / 60);
            const secs = total % 60;
            return `${hours}h ${minutes}m ${secs}s`;
        }

        function formatAgeSeconds(seconds) {
            if (seconds === null || seconds === undefined) {
                return '-';
            }
            const total = Math.floor(Number(seconds));
            if (Number.isNaN(total)) {
                return '-';
            }
            if (total < 60) {
                return `${total}s`;
            }
            return formatDuration(total);
        }

        function formatTimestamp(value) {
            if (!value) {
                return '-';
            }
            if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(value)) {
                return value;
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return String(value);
            }
            return date.toLocaleString('sv-SE', SWEDISH_TIMESTAMP_OPTIONS);
        }

        function formatList(values) {
            if (!Array.isArray(values) || values.length === 0) {
                return '-';
            }
            return values.join(', ');
        }

        function formatProviders(providers) {
            if (!providers || typeof providers !== 'object') {
                return '-';
            }
            const entries = Object.entries(providers);
            if (!entries.length) {
                return '-';
            }
            return entries
                .map(([key, name]) => `${key.toUpperCase()}: ${name}`)
                .join(', ');
        }

        function toLocalDateTimeValue(value) {
            if (!value) {
                return '';
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return '';
            }
            const offset = date.getTimezoneOffset();
            const local = new Date(date.getTime() - offset * 60000);
            return local.toISOString().slice(0, 16);
        }

        function buildStatusCard(title, rows) {
            const dl = rows.map(row => {
                return `<dt>${escapeHtml(row.label)}</dt><dd>${escapeHtml(row.value)}</dd>`;
            }).join('');
            return `
                <div class="status-card">
                    <h3>${escapeHtml(title)}</h3>
                    <dl>${dl}</dl>
                </div>
            `;
        }

        function buildSportCard(sport) {
            const title = sport?.name || sport?.id || 'Unknown sport';
            const rows = [
                { label: 'ID', value: sport?.id || '-' },
                { label: 'Icon', value: sport?.icon || '-' }
            ];
            return buildStatusCard(title, rows);
        }

        async function apiRequest(path, options = {}) {
            const response = await fetch(path, options);
            const payload = await response.json().catch(() => ({}));
            if (!response.ok) {
                throw new Error(payload.error || 'Request failed');
            }
            return payload;
        }

        const TARGET_PLACEHOLDERS = {
            tags: 'No ID needed (uses tags)',
            subscription: 'OneSignal subscription ID',
            player: 'OneSignal player ID',
            external: 'External user ID'
        };

        function updateTargetInput(select, input) {
            const type = select.value;
            input.placeholder = TARGET_PLACEHOLDERS[type] || 'Target ID';
            const shouldDisable = type === 'tags';
            input.disabled = shouldDisable;
            if (shouldDisable) {
                input.value = '';
            }
        }

        function buildTargetPayload(type, id) {
            if (type === 'tags') {
                return {};
            }
            const trimmed = id.trim();
            if (!trimmed) {
                throw new Error('Target ID is required for the selected target type.');
            }
            if (type === 'subscription') {
                return { subscriptionId: trimmed };
            }
            if (type === 'player') {
                return { playerId: trimmed };
            }
            if (type === 'external') {
                return { externalUserId: trimmed };
            }
            return {};
        }

        function parseNumericInput(value) {
            const trimmed = String(value || '').trim();
            if (!trimmed) {
                return null;
            }
            const parsed = Number(trimmed);
            return Number.isNaN(parsed) ? null : parsed;
        }

        async function loadStatus(options = {}) {
            const { showMessage = false } = options;
            try {
                const status = await apiRequest('/api/status');
                const lastSchedulerError = status.scheduler?.recentErrors?.length
                    ? status.scheduler.recentErrors[status.scheduler.recentErrors.length - 1]
                    : null;
                const serverRows = [
                    { label: 'Uptime', value: formatDuration(status.server?.uptime) },
                    { label: 'Timestamp', value: formatTimestamp(status.server?.timestamp) },
                    { label: 'Providers', value: formatProviders(status.providers) },
                    { label: 'Sports', value: formatList(status.availableSports) }
                ];
                const notifierRows = [
                    { label: 'Running', value: status.notifier?.running ? 'Yes' : 'No' },
                    { label: 'Last check', value: formatTimestamp(status.notifier?.lastCheck) },
                    { label: 'Games checked', value: status.notifier?.gamesChecked ?? '-' },
                    { label: 'Notifications', value: status.notifier?.totalNotificationsSent ?? '-' },
                    { label: 'Seen games', value: status.notifier?.seenGamesCount ?? '-' },
                    { label: 'Seen videos', value: status.notifier?.seenVideosCount ?? '-' }
                ];
                const schedulerRows = [
                    { label: 'Running', value: status.scheduler?.running ? 'Yes' : 'No' },
                    { label: 'Biathlon last check', value: formatTimestamp(status.scheduler?.biathlon?.lastCheck) },
                    { label: 'Biathlon checks', value: status.scheduler?.biathlon?.checkCount ?? '-' },
                    { label: 'Biathlon interval', value: status.scheduler?.biathlon?.checkInterval ?? '-' },
                    { label: 'Biathlon cache', value: formatTimestamp(status.scheduler?.biathlon?.cacheLastUpdate) },
                    { label: 'Recent errors', value: status.scheduler?.recentErrors?.length ?? 0 },
                    {
                        label: 'Last error',
                        value: lastSchedulerError
                            ? `${lastSchedulerError.message} (${formatTimestamp(lastSchedulerError.timestamp)})`
                            : '-'
                    }
                ];
                const gamesCacheRows = [
                    { label: 'Cached', value: status.cache?.games?.cached ? 'Yes' : 'No' },
                    { label: 'Age', value: formatAgeSeconds(status.cache?.games?.ageSeconds) },
                    { label: 'Fast refresh', value: status.cache?.games?.hasLiveGame ? 'Yes' : 'No' },
                    { label: 'Duration', value: status.cache?.games?.cacheDuration ?? '-' }
                ];
                const mediaCacheRows = [
                    { label: 'Details entries', value: status.cache?.details?.entriesCount ?? '-' },
                    { label: 'Details TTL', value: status.cache?.details?.cacheDuration ?? '-' },
                    { label: 'Videos entries', value: status.cache?.videos?.entriesCount ?? '-' },
                    { label: 'Videos TTL', value: status.cache?.videos?.cacheDuration ?? '-' }
                ];
                const standingsCacheRows = [
                    { label: 'Standings cached', value: status.cache?.standings?.cached ? 'Yes' : 'No' },
                    { label: 'Standings age', value: formatAgeSeconds(status.cache?.standings?.ageSeconds) },
                    { label: 'Standings TTL', value: status.cache?.standings?.cacheDuration ?? '-' },
                    { label: 'Biathlon cached', value: status.cache?.biathlon?.cached ? 'Yes' : 'No' },
                    { label: 'Biathlon age', value: formatAgeSeconds(status.cache?.biathlon?.ageSeconds) },
                    { label: 'Biathlon update', value: formatTimestamp(status.cache?.biathlon?.lastUpdate) },
                    { label: 'Biathlon TTL', value: status.cache?.biathlon?.cacheDuration ?? '-' }
                ];
                const refreshRows = [
                    { label: 'Games normal', value: status.refreshRates?.gamesNormal ?? '-' },
                    { label: 'Games live', value: status.refreshRates?.gamesLive ?? '-' },
                    { label: 'Game details', value: status.refreshRates?.gameDetails ?? '-' },
                    { label: 'Videos', value: status.refreshRates?.videos ?? '-' },
                    { label: 'Standings', value: status.refreshRates?.standings ?? '-' },
                    { label: 'Biathlon', value: status.refreshRates?.biathlon ?? '-' },
                    { label: 'Notifier normal', value: status.refreshRates?.notifierNormal ?? '-' },
                    { label: 'Notifier live', value: status.refreshRates?.notifierLive ?? '-' },
                    { label: 'Biathlon scheduler', value: status.refreshRates?.biathlonScheduler ?? '-' }
                ];

                statusGrid.innerHTML = [
                    buildStatusCard('Server', serverRows),
                    buildStatusCard('Notifier', notifierRows),
                    buildStatusCard('Scheduler', schedulerRows),
                    buildStatusCard('Cache: Games', gamesCacheRows),
                    buildStatusCard('Cache: Media', mediaCacheRows),
                    buildStatusCard('Cache: Standings & Biathlon', standingsCacheRows),
                    buildStatusCard('Refresh rates', refreshRows)
                ].join('');

                if (showMessage) {
                    showFeedback(statusFeedback, 'Status updated', 'success');
                }
            } catch (error) {
                showFeedback(statusFeedback, error.message, 'error');
            }
        }

        function populateTeamSelect(select) {
            select.innerHTML = teams.map(team => {
                return `<option value="${escapeHtml(team.code)}">${escapeHtml(team.names.long || team.names.short || team.code)}</option>`;
            }).join('');
        }

        function updateVenueFromHomeTeam() {
            if (venueTouched) {
                return;
            }
            const selected = teams.find(team => team.code === homeTeamSelect.value);
            venueInput.value = selected?.arena || '';
        }

        function renderGames(records) {
            gamesList.innerHTML = '';
            gamesCount.textContent = records.length ? `${records.length} manual game(s).` : 'No manual games yet.';

            if (!records.length) {
                return;
            }

            records.forEach(record => {
                const game = record.game;
                const card = document.createElement('div');
                card.className = 'game-card';
                card.dataset.id = record.id;

                const stateOptions = ['live', 'pre-game', 'post-game'].map(state => {
                    const label = state === 'pre-game' ? 'Pre-game' : state === 'post-game' ? 'Post-game' : 'Live';
                    return `<option value="${state}" ${record.state === state ? 'selected' : ''}>${label}</option>`;
                }).join('');

                card.innerHTML = `
                    <div class="game-header">
                        <div>
                            <div class="game-title">${escapeHtml(game.homeTeamInfo.names.short)} vs ${escapeHtml(game.awayTeamInfo.names.short)}</div>
                            <div class="game-meta">${escapeHtml(record.id)}</div>
                        </div>
                        <div>
                            <label>State</label>
                            <select data-field="state">${stateOptions}</select>
                        </div>
                    </div>
                    <div class="game-grid">
                        <div>
                            <label>Start time</label>
                            <input type="datetime-local" data-field="startDateTime" value="${toLocalDateTimeValue(record.startDateTime)}" />
                        </div>
                        <div>
                            <label>Venue</label>
                            <input type="text" data-field="venue" value="${escapeHtml(record.venue)}" />
                        </div>
                        <div>
                            <label>Home score</label>
                            <input type="number" min="0" data-field="homeScore" value="${record.homeScore}" />
                        </div>
                        <div>
                            <label>Away score</label>
                            <input type="number" min="0" data-field="awayScore" value="${record.awayScore}" />
                        </div>
                    </div>
                    <div class="game-actions">
                        <button data-action="save">Save changes</button>
                        <button class="danger" data-action="delete">Delete</button>
                    </div>
                    <p class="muted">Updated ${escapeHtml(formatTimestamp(record.updatedAt))}</p>
                `;

                const saveButton = card.querySelector('[data-action="save"]');
                const deleteButton = card.querySelector('[data-action="delete"]');

                saveButton.addEventListener('click', async () => {
                    const payload = {
                        state: card.querySelector('[data-field="state"]').value,
                        startDateTime: card.querySelector('[data-field="startDateTime"]').value,
                        venue: card.querySelector('[data-field="venue"]').value,
                        homeScore: card.querySelector('[data-field="homeScore"]').value,
                        awayScore: card.querySelector('[data-field="awayScore"]').value
                    };

                    try {
                        saveButton.disabled = true;
                        await apiRequest(`/api/admin/games/${record.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        await loadGames();
                        showFeedback(gamesFeedback, 'Game updated', 'success');
                    } catch (error) {
                        showFeedback(gamesFeedback, error.message, 'error');
                    } finally {
                        saveButton.disabled = false;
                    }
                });

                deleteButton.addEventListener('click', async () => {
                    if (!window.confirm('Delete this manual game?')) {
                        return;
                    }
                    try {
                        deleteButton.disabled = true;
                        await apiRequest(`/api/admin/games/${record.id}`, { method: 'DELETE' });
                        await loadGames();
                        showFeedback(gamesFeedback, 'Game deleted', 'success');
                    } catch (error) {
                        showFeedback(gamesFeedback, error.message, 'error');
                    } finally {
                        deleteButton.disabled = false;
                    }
                });

                gamesList.appendChild(card);
            });
        }

        async function loadGames() {
            try {
                const data = await apiRequest('/api/admin/games');
                renderGames(data.games || []);
            } catch (error) {
                showFeedback(gamesFeedback, error.message, 'error');
            }
        }

        async function loadTeams() {
            const data = await apiRequest('/api/teams');
            teams = (data || []).sort((a, b) => a.code.localeCompare(b.code));
            populateTeamSelect(homeTeamSelect);
            populateTeamSelect(awayTeamSelect);
            awayTeamSelect.selectedIndex = 1;
            updateVenueFromHomeTeam();
            // Also populate goal test dropdowns with SHL teams by default
            updateGoalTestTeamDropdowns();
        }

        async function loadFootballTeams() {
            try {
                const games = await apiRequest('/api/football/games?limit=100');
                const teamMap = new Map();

                (games || []).forEach(game => {
                    if (game.homeTeamInfo) {
                        const code = game.homeTeamInfo.code || game.homeTeamInfo.uuid;
                        if (code && !teamMap.has(code)) {
                            teamMap.set(code, {
                                code,
                                name: game.homeTeamInfo.names?.long || game.homeTeamInfo.names?.short || code
                            });
                        }
                    }
                    if (game.awayTeamInfo) {
                        const code = game.awayTeamInfo.code || game.awayTeamInfo.uuid;
                        if (code && !teamMap.has(code)) {
                            teamMap.set(code, {
                                code,
                                name: game.awayTeamInfo.names?.long || game.awayTeamInfo.names?.short || code
                            });
                        }
                    }
                });

                footballTeams = Array.from(teamMap.values()).sort((a, b) => a.name.localeCompare(b.name));
                console.log(`[Admin] Loaded ${footballTeams.length} football teams`);
            } catch (error) {
                console.error('[Admin] Error loading football teams:', error);
                footballTeams = [];
            }
        }

        function updateGoalTestTeamDropdowns() {
            const sport = goalTestSport.value;
            const teamList = sport === 'allsvenskan' ? footballTeams : teams;

            const buildOptions = (list) => {
                if (sport === 'allsvenskan') {
                    return list.map(team => {
                        return `<option value="${escapeHtml(team.code)}">${escapeHtml(team.name)} (${escapeHtml(team.code)})</option>`;
                    }).join('');
                } else {
                    return list.map(team => {
                        const name = team.names?.long || team.names?.short || team.code;
                        return `<option value="${escapeHtml(team.code)}">${escapeHtml(name)} (${escapeHtml(team.code)})</option>`;
                    }).join('');
                }
            };

            goalTestScoringTeam.innerHTML = buildOptions(teamList);
            goalTestOpposingTeam.innerHTML = buildOptions(teamList);

            // Set different default selections
            if (teamList.length > 1) {
                goalTestOpposingTeam.selectedIndex = 1;
            }

            // Update period placeholder based on sport
            goalTestPeriod.placeholder = sport === 'allsvenskan' ? '1st half' : 'P1';
            goalTestTime.placeholder = sport === 'allsvenskan' ? '54:21' : '12:34';
        }

        async function loadSports(options = {}) {
            const { showMessage = false } = options;
            try {
                const data = await apiRequest('/api/sports');
                sports = Array.isArray(data) ? data : [];
                sports.sort((a, b) => (a.id || '').localeCompare(b.id || ''));

                if (sports.length) {
                    sportsGrid.innerHTML = sports.map(buildSportCard).join('');
                } else {
                    sportsGrid.innerHTML = '<p class="muted">No sports available yet.</p>';
                }

                if (showMessage) {
                    showFeedback(sportsFeedback, `Loaded ${sports.length} sport(s)`, 'success');
                }
            } catch (error) {
                showFeedback(sportsFeedback, error.message, 'error');
            }
        }

        async function loadPushStatus(options = {}) {
            const { showMessage = false } = options;
            try {
                const status = await apiRequest('/api/notifications/status');

                const pushRows = [
                    { label: 'Configured', value: status.pushNotifications?.configured ? 'Yes' : 'No' },
                    { label: 'Notifications sent', value: status.pushNotifications?.notificationsSent ?? 0 },
                    { label: 'Errors', value: status.pushNotifications?.errors ?? 0 },
                    { label: 'Last sent', value: formatTimestamp(status.pushNotifications?.lastSent) }
                ];

                const goalWatcherRows = [
                    { label: 'Running', value: status.goalWatcher?.running ? 'Yes' : 'No' },
                    { label: 'Last check', value: formatTimestamp(status.goalWatcher?.lastCheck) },
                    { label: 'Games checked', value: status.goalWatcher?.gamesChecked ?? 0 },
                    { label: 'Goals detected', value: status.goalWatcher?.totalGoalsDetected ?? 0 },
                    { label: 'Notifications sent', value: status.goalWatcher?.totalNotificationsSent ?? 0 },
                    { label: 'Tracked games', value: status.goalWatcher?.trackedGames ?? 0 }
                ];

                pushStatusGrid.innerHTML = [
                    buildStatusCard('OneSignal', pushRows),
                    buildStatusCard('Goal Watcher', goalWatcherRows)
                ].join('');

                if (showMessage) {
                    showFeedback(pushFeedback, 'Push status updated', 'success');
                }
            } catch (error) {
                showFeedback(pushFeedback, error.message, 'error');
            }
        }

        refreshStatusButton.addEventListener('click', () => loadStatus({ showMessage: true }));
        refreshSportsButton.addEventListener('click', () => loadSports({ showMessage: true }));
        clearCacheButton.addEventListener('click', async () => {
            try {
                clearCacheButton.disabled = true;
                const result = await apiRequest('/api/cache/clear', { method: 'POST' });
                const details = [
                    result.message || 'All caches cleared',
                    result.timestamp ? `Timestamp: ${formatTimestamp(result.timestamp)}` : null
                ].filter(Boolean);
                showFeedback(statusFeedback, details.join('\n'), 'success');
                await loadStatus();
            } catch (error) {
                showFeedback(statusFeedback, error.message, 'error');
            } finally {
                clearCacheButton.disabled = false;
            }
        });
        runNotifierButton.addEventListener('click', async () => {
            try {
                runNotifierButton.disabled = true;
                const result = await apiRequest('/api/notifier/check', { method: 'POST' });
                const details = [
                    result.message || 'Notifier check completed',
                    result.timestamp ? `Timestamp: ${formatTimestamp(result.timestamp)}` : null,
                    result.gamesChecked !== undefined ? `Games checked: ${result.gamesChecked}` : null
                ].filter(Boolean);
                showFeedback(statusFeedback, details.join('\n'), 'success');
                await loadStatus();
            } catch (error) {
                showFeedback(statusFeedback, error.message, 'error');
            } finally {
                runNotifierButton.disabled = false;
            }
        });
        refreshBiathlonButton.addEventListener('click', async () => {
            try {
                refreshBiathlonButton.disabled = true;
                const result = await apiRequest('/api/biathlon/refresh', { method: 'POST' });
                const details = [
                    result.message || 'Biathlon schedule refreshed',
                    result.timestamp ? `Timestamp: ${formatTimestamp(result.timestamp)}` : null,
                    result.racesCount !== undefined ? `Races: ${result.racesCount}` : null
                ].filter(Boolean);

                if (result.validation) {
                    const issueCount = result.validation.issues?.length ?? 0;
                    details.push(
                        result.validation.valid
                            ? 'Validation: OK'
                            : `Validation issues: ${issueCount}`
                    );
                    if (!result.validation.valid && Array.isArray(result.validation.issues)) {
                        result.validation.issues.forEach(issue => details.push(`- ${issue}`));
                    }
                }

                showFeedback(statusFeedback, details.join('\n'), 'success');
                await loadStatus();
            } catch (error) {
                showFeedback(statusFeedback, error.message, 'error');
            } finally {
                refreshBiathlonButton.disabled = false;
            }
        });

        venueInput.addEventListener('input', () => {
            venueTouched = true;
        });
        homeTeamSelect.addEventListener('change', updateVenueFromHomeTeam);

        refreshPushStatusButton.addEventListener('click', () => loadPushStatus({ showMessage: true }));

        runGoalWatcherButton.addEventListener('click', async () => {
            try {
                runGoalWatcherButton.disabled = true;
                const result = await apiRequest('/api/goal-watcher/check', { method: 'POST' });
                const details = [
                    result.message || 'Goal check completed',
                    result.timestamp ? `Timestamp: ${formatTimestamp(result.timestamp)}` : null,
                    result.gamesChecked !== undefined ? `Games checked: ${result.gamesChecked}` : null,
                    result.newGoals?.length ? `New goals found: ${result.newGoals.length}` : 'No new goals',
                    result.notificationsSent !== undefined ? `Notifications sent: ${result.notificationsSent}` : null
                ].filter(Boolean);
                showFeedback(pushFeedback, details.join('\n'), 'success');
                await loadPushStatus();
            } catch (error) {
                showFeedback(pushFeedback, error.message, 'error');
            } finally {
                runGoalWatcherButton.disabled = false;
            }
        });

        sendTestPushButton.addEventListener('click', async () => {
            try {
                sendTestPushButton.disabled = true;
                const message = testPushMessageInput.value.trim() || undefined;
                const targetPayload = buildTargetPayload(testPushTargetType.value, testPushTargetId.value);
                const body = {
                    ...(message ? { message } : {}),
                    ...targetPayload
                };
                const result = await apiRequest('/api/notifications/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const details = [
                    result.success ? 'Test notification sent!' : 'Failed to send notification',
                    result.timestamp ? `Timestamp: ${formatTimestamp(result.timestamp)}` : null,
                    result.result?.recipients !== undefined ? `Recipients: ${result.result.recipients}` : null,
                    result.target ? `Target: ${JSON.stringify(result.target)}` : null,
                    result.result?.error ? `Error: ${result.result.error}` : null
                ].filter(Boolean);
                showFeedback(pushFeedback, details.join('\n'), result.success ? 'success' : 'error');
                await loadPushStatus();
            } catch (error) {
                showFeedback(pushFeedback, error.message, 'error');
            } finally {
                sendTestPushButton.disabled = false;
            }
        });

        sendGoalTestButton.addEventListener('click', async () => {
            try {
                sendGoalTestButton.disabled = true;
                const scoringTeamCode = goalTestScoringTeam.value;
                const opposingTeamCode = goalTestOpposingTeam.value;

                if (!scoringTeamCode || !opposingTeamCode) {
                    throw new Error('Please select both scoring and opposing teams.');
                }

                if (scoringTeamCode === opposingTeamCode) {
                    throw new Error('Scoring and opposing teams must be different.');
                }

                const targetPayload = buildTargetPayload(goalTestTargetType.value, goalTestTargetId.value);
                const homeScoreValue = parseNumericInput(goalTestHomeScore.value);
                const awayScoreValue = parseNumericInput(goalTestAwayScore.value);
                const periodValue = goalTestPeriod.value.trim();
                const timeValue = goalTestTime.value.trim();
                const scorerNameValue = goalTestScorerName.value.trim();

                const body = {
                    sport: goalTestSport.value,
                    scoringTeamCode,
                    opposingTeamCode,
                    scoringIsHome: goalTestScoringHome.checked,
                    ...(homeScoreValue !== null ? { homeScore: homeScoreValue } : {}),
                    ...(awayScoreValue !== null ? { awayScore: awayScoreValue } : {}),
                    ...(periodValue ? { period: periodValue } : {}),
                    ...(timeValue ? { time: timeValue } : {}),
                    ...(scorerNameValue ? { scorerName: scorerNameValue } : {}),
                    sendOpposing: goalTestSendOpposing.checked,
                    ...targetPayload
                };

                const result = await apiRequest('/api/notifications/goal-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const details = [
                    result.success ? 'Goal notification sent!' : 'Failed to send goal notification',
                    result.timestamp ? `Timestamp: ${formatTimestamp(result.timestamp)}` : null,
                    result.goal?.scoringTeamCode ? `Goal: ${result.goal.scoringTeamCode} vs ${result.goal.opposingTeamCode}` : null,
                    result.result?.recipients !== undefined ? `Recipients: ${result.result.recipients}` : null,
                    result.target ? `Target: ${JSON.stringify(result.target)}` : null,
                    result.result?.error ? `Error: ${result.result.error}` : null
                ].filter(Boolean);
                showFeedback(pushFeedback, details.join('\n'), result.success ? 'success' : 'error');
                await loadPushStatus();
            } catch (error) {
                showFeedback(pushFeedback, error.message, 'error');
            } finally {
                sendGoalTestButton.disabled = false;
            }
        });

        createForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const payload = {
                homeTeamCode: homeTeamSelect.value,
                awayTeamCode: awayTeamSelect.value,
                state: gameStateSelect.value,
                startDateTime: startTimeInput.value,
                venue: venueInput.value,
                homeScore: homeScoreInput.value,
                awayScore: awayScoreInput.value
            };

            if (payload.homeTeamCode === payload.awayTeamCode) {
                showFeedback(createFeedback, 'Home and away teams must differ', 'error');
                return;
            }

            try {
                const submitButton = createForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                await apiRequest('/api/admin/games', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                showFeedback(createFeedback, 'Game created', 'success');
                homeScoreInput.value = 0;
                awayScoreInput.value = 0;
                gameStateSelect.value = 'live';
                startTimeInput.value = toLocalDateTimeValue(new Date());
                venueTouched = false;
                updateVenueFromHomeTeam();
                await loadGames();
            } catch (error) {
                showFeedback(createFeedback, error.message, 'error');
            } finally {
                const submitButton = createForm.querySelector('button[type="submit"]');
                submitButton.disabled = false;
            }
        });

        function init() {
            startTimeInput.value = toLocalDateTimeValue(new Date());

            // Load both SHL and football teams, then populate dropdowns
            Promise.all([loadTeams(), loadFootballTeams()])
                .then(() => {
                    updateGoalTestTeamDropdowns();
                    return loadGames();
                })
                .catch(error => showFeedback(createFeedback, error.message, 'error'));

            loadStatus({ showMessage: true });
            loadSports();
            loadPushStatus();
            updateTargetInput(testPushTargetType, testPushTargetId);
            updateTargetInput(goalTestTargetType, goalTestTargetId);
            testPushTargetType.addEventListener('change', () => updateTargetInput(testPushTargetType, testPushTargetId));
            goalTestTargetType.addEventListener('change', () => {
                updateTargetInput(goalTestTargetType, goalTestTargetId);
                if (goalTestTargetType.value !== 'tags') {
                    goalTestSendOpposing.checked = false;
                } else {
                    goalTestSendOpposing.checked = true;
                }
            });

            // Update team dropdowns when sport changes
            goalTestSport.addEventListener('change', updateGoalTestTeamDropdowns);

            setInterval(() => loadStatus(), 15000);
            setInterval(() => loadPushStatus(), 15000);
        }

        init();
    </script>
</body>
</html>
