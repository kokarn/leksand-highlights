<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GamePulse Admin Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-color: #0a0f1a;
            --bg-secondary: #111827;
            --panel-bg: rgba(17, 24, 39, 0.95);
            --panel-border: rgba(75, 85, 99, 0.4);
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --accent-glow: rgba(59, 130, 246, 0.3);
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --success: #22c55e;
            --warning: #f59e0b;
            --purple: #a855f7;
            --cyan: #06b6d4;
            --card-bg: rgba(31, 41, 55, 0.6);
            --input-bg: rgba(17, 24, 39, 0.8);
            --shadow-lg: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        }

        body {
            background: var(--bg-color);
            background-image:
                radial-gradient(ellipse at top, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(168, 85, 247, 0.05) 0%, transparent 50%);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Sidebar Navigation */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--panel-border);
            padding: 1.5rem;
            z-index: 100;
            overflow-y: auto;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--panel-border);
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            overflow: hidden;
        }

        .sidebar-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .sidebar-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            padding-left: 0.75rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(59, 130, 246, 0.1);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent);
        }

        .nav-item-icon {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            padding: 2rem;
            max-width: 1400px;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .top-bar-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* Status Indicator */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--panel-border);
            border-radius: 2rem;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-dot.warning { background: var(--warning); }
        .status-dot.error { background: var(--danger); animation: none; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Dashboard Cards Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 1rem;
            padding: 1.25rem;
            transition: all 0.2s ease;
        }

        .metric-card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .metric-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .metric-icon {
            width: 36px;
            height: 36px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .metric-icon.blue { background: rgba(59, 130, 246, 0.2); color: var(--accent); }
        .metric-icon.green { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .metric-icon.purple { background: rgba(168, 85, 247, 0.2); color: var(--purple); }
        .metric-icon.cyan { background: rgba(6, 182, 212, 0.2); color: var(--cyan); }
        .metric-icon.orange { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .metric-change {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .metric-change.positive { color: var(--success); }
        .metric-change.negative { color: var(--danger); }

        .cache-status-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .cache-status-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .cache-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .cache-status-dot.active {
            background: var(--success);
        }

        .cache-status-dot.inactive {
            background: var(--text-muted);
        }

        /* Section Panel */
        .section {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--panel-border);
            cursor: pointer;
            user-select: none;
        }

        .section-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .section-title-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-icon {
            font-size: 1.1rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .section-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent);
            font-weight: 600;
        }

        .section-toggle {
            font-size: 1rem;
            color: var(--text-muted);
            transition: transform 0.2s ease;
        }

        .section.collapsed .section-toggle {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 1.5rem;
        }

        .section.collapsed .section-content {
            display: none;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .chart-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .chart-wrapper {
            height: 200px;
            position: relative;
        }

        /* Status Grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .status-card {
            background: var(--card-bg);
            border: 1px solid rgba(75, 85, 99, 0.3);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
        }

        .status-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .status-card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent);
        }

        .status-card-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }

        .status-card-badge.online {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .status-card-badge.offline {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .status-card dl {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.4rem 1rem;
            font-size: 0.85rem;
        }

        .status-card dt {
            color: var(--text-muted);
        }

        .status-card dd {
            text-align: right;
            font-weight: 500;
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: rgba(75, 85, 99, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--cyan));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
            border-radius: 0.5rem;
            padding: 0.6rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .btn-secondary {
            background: rgba(75, 85, 99, 0.3);
            color: var(--text-primary);
            border: 1px solid var(--panel-border);
        }

        .btn-secondary:hover {
            background: rgba(75, 85, 99, 0.5);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: var(--danger-hover);
        }

        .btn-sm {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .form-group label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--panel-border);
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.15s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-check input {
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
        }

        .form-check label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Game Cards */
        .games-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .game-card {
            background: var(--card-bg);
            border: 1px solid rgba(75, 85, 99, 0.3);
            border-radius: 0.75rem;
            padding: 1.25rem;
            transition: all 0.15s ease;
        }

        .game-card:hover {
            border-color: var(--panel-border);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .game-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .game-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: monospace;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .game-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--panel-border);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            min-width: 280px;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-icon {
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .toast.success .toast-icon { color: var(--success); }
        .toast.error .toast-icon { color: var(--danger); }
        .toast.warning .toast-icon { color: var(--warning); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1rem;
        }

        /* Activity Timeline */
        .activity-list {
            display: flex;
            flex-direction: column;
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(75, 85, 99, 0.2);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .activity-icon.goal { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .activity-icon.cache { background: rgba(59, 130, 246, 0.2); color: var(--accent); }
        .activity-icon.error { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .activity-icon.info { background: rgba(168, 85, 247, 0.2); color: var(--purple); }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: flex;
            }
        }

        @media (max-width: 640px) {
            .main-content {
                padding: 1rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .text-muted { color: var(--text-muted); }
        .text-sm { font-size: 0.85rem; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }

        /* Lucide Icon Styles */
        .icon-sm {
            width: 18px;
            height: 18px;
            stroke-width: 2;
        }

        .icon-md {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .icon-btn {
            width: 16px;
            height: 16px;
            stroke-width: 2;
            vertical-align: -3px;
            margin-right: 2px;
        }

        .nav-item-icon i {
            color: inherit;
        }

        .section-icon i {
            color: var(--accent);
        }

        .section-toggle i {
            transition: transform 0.2s ease;
        }

        .section.collapsed .section-toggle i {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo"><img src="/static/app-icon.png" alt="GamePulse"></div>
            <div>
                <div class="sidebar-title">GamePulse</div>
                <div class="sidebar-subtitle">Admin Console</div>
            </div>
        </div>

        <nav>
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <div class="nav-item active" data-section="dashboard">
                    <span class="nav-item-icon"><i data-lucide="layout-dashboard" class="icon-sm"></i></span>
                    Dashboard
                </div>
                <div class="nav-item" data-section="activity">
                    <span class="nav-item-icon"><i data-lucide="scroll-text" class="icon-sm"></i></span>
                    Activity Log
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Operations</div>
                <div class="nav-item" data-section="status">
                    <span class="nav-item-icon"><i data-lucide="monitor" class="icon-sm"></i></span>
                    System Status
                </div>
                <div class="nav-item" data-section="cache">
                    <span class="nav-item-icon"><i data-lucide="database" class="icon-sm"></i></span>
                    Cache Management
                </div>
                <div class="nav-item" data-section="sports">
                    <span class="nav-item-icon"><i data-lucide="trophy" class="icon-sm"></i></span>
                    Sports Providers
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Notifications</div>
                <div class="nav-item" data-section="push">
                    <span class="nav-item-icon"><i data-lucide="bell" class="icon-sm"></i></span>
                    Push Notifications
                </div>
                <div class="nav-item" data-section="goal-test">
                    <span class="nav-item-icon"><i data-lucide="circle-dot" class="icon-sm"></i></span>
                    Goal Testing
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Games</div>
                <div class="nav-item" data-section="create-game">
                    <span class="nav-item-icon"><i data-lucide="plus-circle" class="icon-sm"></i></span>
                    Create Game
                </div>
                <div class="nav-item" data-section="games">
                    <span class="nav-item-icon"><i data-lucide="gamepad-2" class="icon-sm"></i></span>
                    Manual Games
                </div>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1 class="page-title" id="page-title">Dashboard</h1>
            <div class="top-bar-actions">
                <div class="status-indicator">
                    <span class="status-dot" id="server-status-dot"></span>
                    <span id="server-status-text">Online</span>
                </div>
                <button class="btn btn-secondary" id="refresh-all">
                    <i data-lucide="refresh-cw" class="icon-btn"></i> Refresh All
                </button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="section-dashboard" class="page-section">
            <!-- Metrics Cards -->
            <div class="dashboard-grid" id="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-label">Uptime</span>
                        <div class="metric-icon blue"><i data-lucide="clock" class="icon-md"></i></div>
                    </div>
                    <div class="metric-value" id="metric-uptime">-</div>
                    <div class="metric-change" id="metric-uptime-sub">Loading...</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-label">Goals Detected</span>
                        <div class="metric-icon green"><i data-lucide="target" class="icon-md"></i></div>
                    </div>
                    <div class="metric-value" id="metric-goals">0</div>
                    <div class="metric-change" id="metric-goals-sub">Total goals</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-label">Notifications Sent</span>
                        <div class="metric-icon purple"><i data-lucide="bell-ring" class="icon-md"></i></div>
                    </div>
                    <div class="metric-value" id="metric-notifications">0</div>
                    <div class="metric-change" id="metric-notifications-sub">Push notifications</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-label">Live Games</span>
                        <div class="metric-icon cyan"><i data-lucide="radio" class="icon-md"></i></div>
                    </div>
                    <div class="metric-value" id="metric-live-games">0</div>
                    <div class="metric-change" id="metric-live-games-sub">Currently tracking</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-label">Cache Status</span>
                        <div class="metric-icon orange"><i data-lucide="hard-drive" class="icon-md"></i></div>
                    </div>
                    <div class="metric-value" id="metric-cache">-</div>
                    <div class="cache-status-list" id="cache-status-list"></div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Notification Activity (Last 24h)</h3>
                        <div class="chart-legend">
                            <div class="chart-legend-item">
                                <span class="legend-dot" style="background: #3b82f6"></span>
                                Sent
                            </div>
                            <div class="chart-legend-item">
                                <span class="legend-dot" style="background: #22c55e"></span>
                                Goals
                            </div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="notifications-chart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Cache Performance</h3>
                        <div class="chart-legend">
                            <div class="chart-legend-item">
                                <span class="legend-dot" style="background: #22c55e"></span>
                                Hits
                            </div>
                            <div class="chart-legend-item">
                                <span class="legend-dot" style="background: #ef4444"></span>
                                Misses
                            </div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="cache-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title-group">
                        <span class="section-icon"><i data-lucide="zap" class="icon-sm"></i></span>
                        <h2 class="section-title">Quick Actions</h2>
                    </div>
                </div>
                <div class="section-content">
                    <div class="btn-group">
                        <button class="btn btn-primary" id="quick-clear-cache"><i data-lucide="trash-2" class="icon-btn"></i> Clear All Caches</button>
                        <button class="btn btn-secondary" id="quick-run-notifier"><i data-lucide="search" class="icon-btn"></i> Run Notifier Check</button>
                        <button class="btn btn-secondary" id="quick-goal-check"><i data-lucide="target" class="icon-btn"></i> Run Goal Check</button>
                        <button class="btn btn-secondary" id="quick-biathlon-refresh"><i data-lucide="snowflake" class="icon-btn"></i> Refresh Biathlon</button>
                    </div>
                    <div id="quick-actions-feedback" class="mt-2 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Activity Log Section -->
        <div id="section-activity" class="page-section hidden">
            <div class="section">
                <div class="section-header" onclick="toggleSection(this.parentElement)">
                    <div class="section-title-group">
                        <span class="section-icon"><i data-lucide="scroll-text" class="icon-sm"></i></span>
                        <h2 class="section-title">Recent Activity</h2>
                        <span class="section-badge" id="activity-count">0 events</span>
                    </div>
                    <span class="section-toggle"><i data-lucide="chevron-down" class="icon-sm"></i></span>
                </div>
                <div class="section-content">
                    <div class="activity-list" id="activity-list">
                        <p class="text-muted">Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status Section -->
        <div id="section-status" class="page-section hidden">
            <div class="section">
                <div class="section-header" onclick="toggleSection(this.parentElement)">
                    <div class="section-title-group">
                        <span class="section-icon"><i data-lucide="monitor" class="icon-sm"></i></span>
                        <h2 class="section-title">System Status</h2>
                    </div>
                    <span class="section-toggle"><i data-lucide="chevron-down" class="icon-sm"></i></span>
                </div>
                <div class="section-content">
                    <div class="status-grid" id="status-grid"></div>
                    <div class="btn-group mt-2">
                        <button class="btn btn-secondary" id="refresh-status"><i data-lucide="refresh-cw" class="icon-btn"></i> Refresh Status</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cache Management Section -->
        <div id="section-cache" class="page-section hidden">
            <div class="section">
                <div class="section-header" onclick="toggleSection(this.parentElement)">
                    <div class="section-title-group">
                        <span class="section-icon"><i data-lucide="database" class="icon-sm"></i></span>
                        <h2 class="section-title">Cache Management</h2>
                    </div>
                    <span class="section-toggle"><i data-lucide="chevron-down" class="icon-sm"></i></span>
                </div>
                <div class="section-content">
                    <div class="status-grid" id="cache-status-grid"></div>
                    <div class="btn-group mt-2">
                        <button class="btn btn-danger" id="clear-cache"><i data-lucide="trash-2" class="icon-btn"></i> Clear All Caches</button>
                        <button class="btn btn-secondary" id="refresh-cache-status"><i data-lucide="refresh-cw" class="icon-btn"></i> Refresh</button>
                    </div>
                    <div id="cache-feedback" class="mt-2 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Sports Providers Section -->
        <div id="section-sports" class="page-section hidden">
            <div class="section">
                <div class="section-header" onclick="toggleSection(this.parentElement)">
                    <div class="section-title-group">
                        <span class="section-icon"><i data-lucide="trophy" class="icon-sm"></i></span>
                        <h2 class="section-title">Sports Providers</h2>
                    </div>
                    <span class="section-toggle"><i data-lucide="chevron-down" class="icon-sm"></i></span>
                </div>
                <div class="section-content">
                    <div class="status-grid" id="sports-grid"></div>
                    <div class="btn-group mt-2">
                        <button class="btn btn-secondary" id="refresh-sports"><i data-lucide="refresh-cw" class="icon-btn"></i> Refresh Sports List</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Push Notifications Section -->
        <div id="section-push" class="page-section hidden">
            <div class="section">
                <div class="section-header" onclick="toggleSection(this.parentElement)">
                    <div class="section-title-group">
                        <span class="section-icon"><i data-lucide="bell" class="icon-sm"></i></span>
                        <h2 class="section-title">Push Notification Status</h2>
                    </div>
                    <span class="section-toggle"><i data-lucide="chevron-down" class="icon-sm"></i></span>
                </div>
                <div class="section-content">
                    <div class="status-grid" id="push-status-grid"></div>
                    <div class="btn-group mt-2">
                        <button class="btn btn-secondary" id="refresh-push-status"><i data-lucide="refresh-cw" class="icon-btn"></i> Refresh Status</button>
                        <button class="btn btn-secondary" id="run-goal-watcher"><i data-lucide="target" class="icon-btn"></i> Run Goal Check</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header" onclick="toggleSection(this.parentElement)">
                    <div class="section-title-group">
                        <span class="section-icon"><i data-lucide="send" class="icon-sm"></i></span>
                        <h2 class="section-title">Send Test Notification</h2>
                    </div>
                    <span class="section-toggle"><i data-lucide="chevron-down" class="icon-sm"></i></span>
                </div>
                <div class="section-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="test-push-message">Message (optional)</label>
                            <input id="test-push-message" type="text" class="form-control" placeholder="Custom message for test notification" />
                        </div>
                        <div class="form-group">
                            <label for="test-push-target-type">Target type</label>
                            <select id="test-push-target-type" class="form-control">
                                <option value="tags">Goal notifications tag</option>
                                <option value="subscription">Subscription ID</option>
                                <option value="player">Player ID (legacy)</option>
                                <option value="external">External user ID</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="test-push-target-id">Target ID (optional)</label>
                            <input id="test-push-target-id" type="text" class="form-control" placeholder="OneSignal subscription ID" />
                        </div>
                    </div>
                    <div class="btn-group mt-2">
                        <button class="btn btn-primary" id="send-test-push"><i data-lucide="send" class="icon-btn"></i> Send Test Notification</button>
                    </div>
                    <div id="push-feedback" class="mt-2 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Goal Testing Section -->
        <div id="section-goal-test" class="page-section hidden">
            <div class="section">
                <div class="section-header" onclick="toggleSection(this.parentElement)">
                    <div class="section-title-group">
                        <span class="section-icon"><i data-lucide="circle-dot" class="icon-sm"></i></span>
                        <h2 class="section-title">Goal Notification Test</h2>
                    </div>
                    <span class="section-toggle"><i data-lucide="chevron-down" class="icon-sm"></i></span>
                </div>
                <div class="section-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="goal-test-sport">Sport</label>
                            <select id="goal-test-sport" class="form-control">
                                <option value="shl">SHL</option>
                                <option value="allsvenskan">Allsvenskan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="goal-test-scoring-team">Scoring team</label>
                            <select id="goal-test-scoring-team" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="goal-test-opposing-team">Opposing team</label>
                            <select id="goal-test-opposing-team" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="goal-test-scorer-name">Scorer name</label>
                            <input id="goal-test-scorer-name" type="text" class="form-control" placeholder="Test Scorer" />
                        </div>
                        <div class="form-group">
                            <label for="goal-test-home-score">Home score</label>
                            <input id="goal-test-home-score" type="number" min="0" class="form-control" placeholder="1" />
                        </div>
                        <div class="form-group">
                            <label for="goal-test-away-score">Away score</label>
                            <input id="goal-test-away-score" type="number" min="0" class="form-control" placeholder="0" />
                        </div>
                        <div class="form-group">
                            <label for="goal-test-period">Period/half</label>
                            <input id="goal-test-period" type="text" class="form-control" placeholder="P1" />
                        </div>
                        <div class="form-group">
                            <label for="goal-test-time">Time</label>
                            <input id="goal-test-time" type="text" class="form-control" placeholder="12:34" />
                        </div>
                        <div class="form-group">
                            <label for="goal-test-target-type">Target type</label>
                            <select id="goal-test-target-type" class="form-control">
                                <option value="tags">Team tags</option>
                                <option value="subscription">Subscription ID</option>
                                <option value="player">Player ID (legacy)</option>
                                <option value="external">External user ID</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="goal-test-target-id">Target ID (optional)</label>
                            <input id="goal-test-target-id" type="text" class="form-control" placeholder="OneSignal subscription ID" />
                        </div>
                    </div>
                    <div class="form-grid mt-2">
                        <div class="form-check">
                            <input id="goal-test-scoring-home" type="checkbox" checked />
                            <label for="goal-test-scoring-home">Scoring team is home team</label>
                        </div>
                        <div class="form-check">
                            <input id="goal-test-send-opposing" type="checkbox" checked />
                            <label for="goal-test-send-opposing">Send opposing notification</label>
                        </div>
                    </div>
                    <div class="btn-group mt-2">
                        <button class="btn btn-primary" id="send-goal-test"><i data-lucide="target" class="icon-btn"></i> Send Goal Test</button>
                    </div>
                    <div id="goal-test-feedback" class="mt-2 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Create Game Section -->
        <div id="section-create-game" class="page-section hidden">
            <div class="section">
                <div class="section-header" onclick="toggleSection(this.parentElement)">
                    <div class="section-title-group">
                        <span class="section-icon"><i data-lucide="plus-circle" class="icon-sm"></i></span>
                        <h2 class="section-title">Create Manual Game</h2>
                    </div>
                    <span class="section-toggle"><i data-lucide="chevron-down" class="icon-sm"></i></span>
                </div>
                <div class="section-content">
                    <form id="create-game-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="home-team">Home team</label>
                                <select id="home-team" class="form-control" required></select>
                            </div>
                            <div class="form-group">
                                <label for="away-team">Away team</label>
                                <select id="away-team" class="form-control" required></select>
                            </div>
                            <div class="form-group">
                                <label for="game-state">State</label>
                                <select id="game-state" class="form-control">
                                    <option value="live">Live</option>
                                    <option value="pre-game">Pre-game</option>
                                    <option value="post-game">Post-game</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="start-time">Start time</label>
                                <input id="start-time" type="datetime-local" class="form-control" required />
                            </div>
                            <div class="form-group">
                                <label for="venue">Venue</label>
                                <input id="venue" type="text" class="form-control" placeholder="Arena name" />
                            </div>
                            <div class="form-group">
                                <label for="home-score">Home score</label>
                                <input id="home-score" type="number" min="0" class="form-control" value="0" />
                            </div>
                            <div class="form-group">
                                <label for="away-score">Away score</label>
                                <input id="away-score" type="number" min="0" class="form-control" value="0" />
                            </div>
                        </div>
                        <div class="btn-group mt-2">
                            <button type="submit" class="btn btn-primary"><i data-lucide="plus" class="icon-btn"></i> Create Game</button>
                        </div>
                    </form>
                    <div id="create-feedback" class="mt-2 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Manual Games Section -->
        <div id="section-games" class="page-section hidden">
            <div class="section">
                <div class="section-header" onclick="toggleSection(this.parentElement)">
                    <div class="section-title-group">
                        <span class="section-icon"><i data-lucide="gamepad-2" class="icon-sm"></i></span>
                        <h2 class="section-title">Manual Games</h2>
                        <span class="section-badge" id="games-badge">0 games</span>
                    </div>
                    <span class="section-toggle"><i data-lucide="chevron-down" class="icon-sm"></i></span>
                </div>
                <div class="section-content">
                    <div class="games-list" id="games-list"></div>
                    <div id="games-feedback" class="mt-2 text-sm"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // ============ DOM Elements ============
        const elements = {
            sidebar: document.getElementById('sidebar'),
            pageTitle: document.getElementById('page-title'),
            toastContainer: document.getElementById('toast-container'),
            statusGrid: document.getElementById('status-grid'),
            cacheStatusGrid: document.getElementById('cache-status-grid'),
            sportsGrid: document.getElementById('sports-grid'),
            pushStatusGrid: document.getElementById('push-status-grid'),
            gamesList: document.getElementById('games-list'),
            activityList: document.getElementById('activity-list'),
            notificationsChart: document.getElementById('notifications-chart'),
            cacheChart: document.getElementById('cache-chart')
        };

        // ============ State ============
        let teams = [];
        let footballTeams = [];
        let sports = [];
        let venueTouched = false;
        let activityLog = [];
        let charts = {};

        // ============ Utilities ============
        function escapeHtml(value) {
            return String(value === null || value === undefined ? '' : value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        const SWEDISH_TIMESTAMP_OPTIONS = {
            timeZone: 'Europe/Stockholm',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };

        function formatDuration(seconds) {
            if (seconds === null || seconds === undefined) { return '-'; }
            const total = Math.floor(Number(seconds));
            if (Number.isNaN(total)) { return '-'; }
            const days = Math.floor(total / 86400);
            const hours = Math.floor((total % 86400) / 3600);
            const minutes = Math.floor((total % 3600) / 60);
            if (days > 0) { return `${days}d ${hours}h`; }
            if (hours > 0) { return `${hours}h ${minutes}m`; }
            return `${minutes}m`;
        }

        function formatDurationLong(seconds) {
            if (seconds === null || seconds === undefined) { return '-'; }
            const total = Math.floor(Number(seconds));
            if (Number.isNaN(total)) { return '-'; }
            const days = Math.floor(total / 86400);
            const hours = Math.floor((total % 86400) / 3600);
            const minutes = Math.floor((total % 3600) / 60);
            const secs = total % 60;
            const parts = [];
            if (days > 0) { parts.push(`${days} days`); }
            if (hours > 0) { parts.push(`${hours} hours`); }
            if (minutes > 0) { parts.push(`${minutes} minutes`); }
            if (secs > 0 && days === 0 && hours === 0) { parts.push(`${secs} seconds`); }
            return parts.join(', ') || '0 seconds';
        }

        function formatAgeSeconds(seconds) {
            if (seconds === null || seconds === undefined) { return '-'; }
            const total = Math.floor(Number(seconds));
            if (Number.isNaN(total)) { return '-'; }
            if (total < 60) { return `${total}s ago`; }
            return formatDuration(total) + ' ago';
        }

        function formatTimestamp(value) {
            if (!value) { return '-'; }
            if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(value)) {
                return value;
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) { return String(value); }
            return date.toLocaleString('sv-SE', SWEDISH_TIMESTAMP_OPTIONS);
        }

        function toLocalDateTimeValue(value) {
            if (!value) { return ''; }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) { return ''; }
            const offset = date.getTimezoneOffset();
            const local = new Date(date.getTime() - offset * 60000);
            return local.toISOString().slice(0, 16);
        }

        // ============ Toast Notifications ============
        function showToast(type, title, message) {
            const icons = { success: '', error: '', warning: '' };
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || ''}</span>
                <div class="toast-content">
                    <div class="toast-title">${escapeHtml(title)}</div>
                    <div class="toast-message">${escapeHtml(message)}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()"></button>
            `;
            elements.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // ============ Navigation ============
        function navigateToSection(sectionId) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            const section = document.getElementById(`section-${sectionId}`);
            const navItem = document.querySelector(`[data-section="${sectionId}"]`);

            if (section) { section.classList.remove('hidden'); }
            if (navItem) { navItem.classList.add('active'); }

            const titles = {
                dashboard: 'Dashboard',
                activity: 'Activity Log',
                status: 'System Status',
                cache: 'Cache Management',
                sports: 'Sports Providers',
                push: 'Push Notifications',
                'goal-test': 'Goal Testing',
                'create-game': 'Create Game',
                games: 'Manual Games'
            };
            elements.pageTitle.textContent = titles[sectionId] || 'Dashboard';
        }

        function toggleSection(section) {
            section.classList.toggle('collapsed');
        }

        // ============ API Requests ============
        async function apiRequest(path, options = {}) {
            const response = await fetch(path, options);
            const payload = await response.json().catch(() => ({}));
            if (!response.ok) {
                throw new Error(payload.error || 'Request failed');
            }
            return payload;
        }

        // ============ Activity Log ============
        function addActivity(type, title, timestamp) {
            activityLog.unshift({ type, title, timestamp: timestamp || new Date().toISOString() });
            if (activityLog.length > 50) { activityLog.pop(); }
            renderActivityLog();
        }

        function renderActivityLog() {
            const icons = {
                goal: '', cache: '', error: '', info: '',
                notification: '', refresh: '', game: ''
            };

            if (activityLog.length === 0) {
                elements.activityList.innerHTML = '<p class="text-muted">No recent activity</p>';
                return;
            }

            elements.activityList.innerHTML = activityLog.slice(0, 20).map(item => `
                <div class="activity-item">
                    <div class="activity-icon ${item.type}">${icons[item.type] || ''}</div>
                    <div class="activity-content">
                        <div class="activity-title">${escapeHtml(item.title)}</div>
                        <div class="activity-time">${formatTimestamp(item.timestamp)}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('activity-count').textContent = `${activityLog.length} events`;
        }

        // ============ Charts ============
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: 'rgba(75, 85, 99, 0.2)' }, ticks: { color: '#9ca3af' } },
                    y: { grid: { color: 'rgba(75, 85, 99, 0.2)' }, ticks: { color: '#9ca3af' }, beginAtZero: true }
                }
            };

            const labels = Array.from({ length: 24 }, (_, i) => `${23 - i}h`).reverse();

            charts.notifications = new Chart(elements.notificationsChart, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Sent', data: Array(24).fill(0), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3 },
                        { label: 'Goals', data: Array(24).fill(0), borderColor: '#22c55e', backgroundColor: 'rgba(34, 197, 94, 0.1)', fill: true, tension: 0.3 }
                    ]
                },
                options: chartOptions
            });

            charts.cache = new Chart(elements.cacheChart, {
                type: 'doughnut',
                data: {
                    labels: ['Hits', 'Misses'],
                    datasets: [{
                        data: [85, 15],
                        backgroundColor: ['#22c55e', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    cutout: '70%'
                }
            });
        }

        // ============ Status Cards ============
        function buildStatusCard(title, rows, badge = null) {
            const badgeHtml = badge
                ? `<span class="status-card-badge ${badge.type}">${escapeHtml(badge.text)}</span>`
                : '';
            const dl = rows.map(row => `<dt>${escapeHtml(row.label)}</dt><dd>${escapeHtml(row.value)}</dd>`).join('');
            return `
                <div class="status-card">
                    <div class="status-card-header">
                        <h3 class="status-card-title">${escapeHtml(title)}</h3>
                        ${badgeHtml}
                    </div>
                    <dl>${dl}</dl>
                </div>
            `;
        }

        // ============ Load Status ============
        async function loadStatus(options = {}) {
            try {
                const status = await apiRequest('/api/status');

                // Update metrics
                document.getElementById('metric-uptime').textContent = formatDuration(status.server?.uptime);
                document.getElementById('metric-uptime-sub').textContent = formatDurationLong(status.server?.uptime);
                document.getElementById('metric-goals').textContent = status.goalWatcher?.totalGoalsDetected ?? 0;
                document.getElementById('metric-notifications').textContent = status.goalWatcher?.totalNotificationsSent ?? 0;
                document.getElementById('metric-live-games').textContent = status.goalWatcher?.trackedGames ?? 0;

                const cacheItems = [
                    { name: 'Hockey Games', active: status.cache?.games?.cached },
                    { name: 'Football Games', active: status.cache?.allsvenskan?.games?.cached },
                    { name: 'Biathlon Races', active: status.cache?.biathlon?.cached },
                    { name: 'Hockey Standings', active: status.cache?.standings?.cached },
                    { name: 'Football Standings', active: status.cache?.allsvenskan?.standings?.cached }
                ];
                const activeCaches = cacheItems.filter(c => c.active).length;
                document.getElementById('metric-cache').textContent = `${activeCaches}/${cacheItems.length}`;

                const cacheStatusList = document.getElementById('cache-status-list');
                cacheStatusList.innerHTML = cacheItems.map(cache => `
                    <div class="cache-status-item">
                        <span class="cache-status-dot ${cache.active ? 'active' : 'inactive'}"></span>
                        <span>${cache.name}</span>
                    </div>
                `).join('');

                // Server status indicator
                const dot = document.getElementById('server-status-dot');
                const text = document.getElementById('server-status-text');
                dot.className = 'status-dot';
                text.textContent = 'Online';

                // Build status cards
                const serverRows = [
                    { label: 'Uptime', value: formatDuration(status.server?.uptime) },
                    { label: 'Timestamp', value: formatTimestamp(status.server?.timestamp) }
                ];
                const notifierRows = [
                    { label: 'Running', value: status.notifier?.running ? 'Yes' : 'No' },
                    { label: 'Last check', value: formatTimestamp(status.notifier?.lastCheck) },
                    { label: 'Games checked', value: status.notifier?.gamesChecked ?? '-' },
                    { label: 'Notifications', value: status.notifier?.totalNotificationsSent ?? '-' }
                ];
                const schedulerRows = [
                    { label: 'Running', value: status.scheduler?.running ? 'Yes' : 'No' },
                    { label: 'Biathlon checks', value: status.scheduler?.biathlon?.checkCount ?? '-' },
                    { label: 'Recent errors', value: status.scheduler?.recentErrors?.length ?? 0 }
                ];
                const goalWatcherRows = [
                    { label: 'Running', value: status.goalWatcher?.running ? 'Yes' : 'No' },
                    { label: 'Last check', value: formatTimestamp(status.goalWatcher?.lastCheck) },
                    { label: 'Tracked games', value: status.goalWatcher?.trackedGames ?? 0 }
                ];

                elements.statusGrid.innerHTML = [
                    buildStatusCard('Server', serverRows, { type: 'online', text: 'Running' }),
                    buildStatusCard('Notifier', notifierRows, { type: status.notifier?.running ? 'online' : 'offline', text: status.notifier?.running ? 'Active' : 'Stopped' }),
                    buildStatusCard('Scheduler', schedulerRows, { type: status.scheduler?.running ? 'online' : 'offline', text: status.scheduler?.running ? 'Active' : 'Stopped' }),
                    buildStatusCard('Goal Watcher', goalWatcherRows, { type: status.goalWatcher?.running ? 'online' : 'offline', text: status.goalWatcher?.running ? 'Active' : 'Stopped' })
                ].join('');

                // Cache status - Games
                const hockeyGamesRows = [
                    { label: 'Cached', value: status.cache?.games?.cached ? 'Yes' : 'No' },
                    { label: 'Age', value: formatAgeSeconds(status.cache?.games?.ageSeconds) },
                    { label: 'Live mode', value: status.cache?.games?.hasLiveGame ? 'Yes (15s)' : 'No (60s)' }
                ];
                const footballGamesRows = [
                    { label: 'Cached', value: status.cache?.allsvenskan?.games?.cached ? 'Yes' : 'No' },
                    { label: 'Age', value: formatAgeSeconds(status.cache?.allsvenskan?.games?.ageSeconds) },
                    { label: 'Live mode', value: status.cache?.allsvenskan?.games?.hasLiveGame ? 'Yes (15s)' : 'No (60s)' }
                ];
                const biathlonRacesRows = [
                    { label: 'Cached', value: status.cache?.biathlon?.cached ? 'Yes' : 'No' },
                    { label: 'Age', value: formatAgeSeconds(status.cache?.biathlon?.ageSeconds) },
                    { label: 'TTL', value: status.cache?.biathlon?.cacheDuration ?? '30m' }
                ];
                const standingsRows = [
                    { label: 'Hockey', value: status.cache?.standings?.cached ? 'Yes' : 'No' },
                    { label: 'Football', value: status.cache?.allsvenskan?.standings?.cached ? 'Yes' : 'No' },
                    { label: 'TTL', value: '5 minutes' }
                ];
                const mediaCacheRows = [
                    { label: 'Game details', value: status.cache?.details?.entriesCount ?? 0 },
                    { label: 'Videos', value: status.cache?.videos?.entriesCount ?? 0 },
                    { label: 'Football details', value: status.cache?.allsvenskan?.details?.entriesCount ?? 0 }
                ];

                elements.cacheStatusGrid.innerHTML = [
                    buildStatusCard('Hockey Games', hockeyGamesRows, { type: status.cache?.games?.cached ? 'online' : 'offline', text: status.cache?.games?.cached ? 'Cached' : 'Empty' }),
                    buildStatusCard('Football Games', footballGamesRows, { type: status.cache?.allsvenskan?.games?.cached ? 'online' : 'offline', text: status.cache?.allsvenskan?.games?.cached ? 'Cached' : 'Empty' }),
                    buildStatusCard('Biathlon Races', biathlonRacesRows, { type: status.cache?.biathlon?.cached ? 'online' : 'offline', text: status.cache?.biathlon?.cached ? 'Cached' : 'Empty' }),
                    buildStatusCard('Standings', standingsRows),
                    buildStatusCard('Media & Details', mediaCacheRows)
                ].join('');

                refreshIcons();

                if (options.showMessage) {
                    showToast('success', 'Status Updated', 'All system status refreshed');
                    addActivity('refresh', 'Status refreshed');
                }
            } catch (error) {
                showToast('error', 'Error', error.message);
            }
        }

        // ============ Load Push Status ============
        async function loadPushStatus(options = {}) {
            try {
                const status = await apiRequest('/api/notifications/status');
                const pushRows = [
                    { label: 'Configured', value: status.pushNotifications?.configured ? 'Yes' : 'No' },
                    { label: 'Notifications sent', value: status.pushNotifications?.notificationsSent ?? 0 },
                    { label: 'Errors', value: status.pushNotifications?.errors ?? 0 },
                    { label: 'Last sent', value: formatTimestamp(status.pushNotifications?.lastSent) }
                ];
                const goalWatcherRows = [
                    { label: 'Running', value: status.goalWatcher?.running ? 'Yes' : 'No' },
                    { label: 'Last check', value: formatTimestamp(status.goalWatcher?.lastCheck) },
                    { label: 'Goals detected', value: status.goalWatcher?.totalGoalsDetected ?? 0 },
                    { label: 'Notifications', value: status.goalWatcher?.totalNotificationsSent ?? 0 }
                ];

                elements.pushStatusGrid.innerHTML = [
                    buildStatusCard('OneSignal', pushRows, { type: status.pushNotifications?.configured ? 'online' : 'offline', text: status.pushNotifications?.configured ? 'Configured' : 'Not configured' }),
                    buildStatusCard('Goal Watcher', goalWatcherRows, { type: status.goalWatcher?.running ? 'online' : 'offline', text: status.goalWatcher?.running ? 'Active' : 'Stopped' })
                ].join('');

                refreshIcons();

                if (options.showMessage) {
                    showToast('success', 'Status Updated', 'Push notification status refreshed');
                }
            } catch (error) {
                showToast('error', 'Error', error.message);
            }
        }

        // ============ Load Sports ============
        async function loadSports(options = {}) {
            try {
                const data = await apiRequest('/api/sports');
                sports = Array.isArray(data) ? data : [];

                const sportIcons = { shl: 'Disc3', allsvenskan: 'Circle', biathlon: 'Crosshair' };
                elements.sportsGrid.innerHTML = sports.map(sport => {
                    const rows = [
                        { label: 'ID', value: sport?.id || '-' },
                        { label: 'Icon', value: sport?.icon || '-' }
                    ];
                    return buildStatusCard(sport?.name || 'Unknown', rows, { type: 'online', text: sport?.id?.toUpperCase() || 'SPORT' });
                }).join('');

                refreshIcons();

                if (options.showMessage) {
                    showToast('success', 'Sports Updated', `Loaded ${sports.length} sport(s)`);
                }
            } catch (error) {
                showToast('error', 'Error', error.message);
            }
        }

        // ============ Load Teams ============
        async function loadTeams() {
            const data = await apiRequest('/api/teams');
            teams = (data || []).sort((a, b) => a.code.localeCompare(b.code));
            populateTeamSelect(document.getElementById('home-team'));
            populateTeamSelect(document.getElementById('away-team'));
            document.getElementById('away-team').selectedIndex = 1;
            updateVenueFromHomeTeam();
            updateGoalTestTeamDropdowns();
        }

        async function loadFootballTeams() {
            try {
                const games = await apiRequest('/api/football/games?limit=100');
                const teamMap = new Map();
                (games || []).forEach(game => {
                    [game.homeTeamInfo, game.awayTeamInfo].forEach(info => {
                        if (info) {
                            const code = info.code || info.uuid;
                            if (code && !teamMap.has(code)) {
                                teamMap.set(code, { code, name: info.names?.long || info.names?.short || code });
                            }
                        }
                    });
                });
                footballTeams = Array.from(teamMap.values()).sort((a, b) => a.name.localeCompare(b.name));
            } catch (error) {
                footballTeams = [];
            }
        }

        function populateTeamSelect(select) {
            select.innerHTML = teams.map(team =>
                `<option value="${escapeHtml(team.code)}">${escapeHtml(team.names.long || team.names.short || team.code)}</option>`
            ).join('');
        }

        function updateVenueFromHomeTeam() {
            if (venueTouched) { return; }
            const venueInput = document.getElementById('venue');
            const homeTeamSelect = document.getElementById('home-team');
            const selected = teams.find(team => team.code === homeTeamSelect.value);
            venueInput.value = selected?.arena || '';
        }

        function updateGoalTestTeamDropdowns() {
            const sport = document.getElementById('goal-test-sport').value;
            const teamList = sport === 'allsvenskan' ? footballTeams : teams;
            const scoringSelect = document.getElementById('goal-test-scoring-team');
            const opposingSelect = document.getElementById('goal-test-opposing-team');

            const buildOptions = (list) => {
                if (sport === 'allsvenskan') {
                    return list.map(team => `<option value="${escapeHtml(team.code)}">${escapeHtml(team.name)}</option>`).join('');
                } else {
                    return list.map(team => `<option value="${escapeHtml(team.code)}">${escapeHtml(team.names?.long || team.names?.short || team.code)}</option>`).join('');
                }
            };

            scoringSelect.innerHTML = buildOptions(teamList);
            opposingSelect.innerHTML = buildOptions(teamList);
            if (teamList.length > 1) { opposingSelect.selectedIndex = 1; }

            document.getElementById('goal-test-period').placeholder = sport === 'allsvenskan' ? '1st half' : 'P1';
            document.getElementById('goal-test-time').placeholder = sport === 'allsvenskan' ? '54:21' : '12:34';
        }

        // ============ Load Games ============
        async function loadGames() {
            try {
                const data = await apiRequest('/api/admin/games');
                renderGames(data.games || []);
            } catch (error) {
                showToast('error', 'Error', error.message);
            }
        }

        function renderGames(records) {
            document.getElementById('games-badge').textContent = `${records.length} games`;

            if (!records.length) {
                elements.gamesList.innerHTML = '<p class="text-muted">No manual games yet. Create one to get started.</p>';
                return;
            }

            elements.gamesList.innerHTML = records.map(record => {
                const game = record.game;
                const stateOptions = ['live', 'pre-game', 'post-game'].map(state => {
                    const label = state === 'pre-game' ? 'Pre-game' : state === 'post-game' ? 'Post-game' : 'Live';
                    return `<option value="${state}" ${record.state === state ? 'selected' : ''}>${label}</option>`;
                }).join('');

                return `
                    <div class="game-card" data-id="${record.id}">
                        <div class="game-header">
                            <div>
                                <div class="game-title">${escapeHtml(game.homeTeamInfo.names.short)} vs ${escapeHtml(game.awayTeamInfo.names.short)}</div>
                                <div class="game-meta">${escapeHtml(record.id)}</div>
                            </div>
                            <div class="form-group">
                                <select data-field="state" class="form-control">${stateOptions}</select>
                            </div>
                        </div>
                        <div class="game-grid">
                            <div class="form-group">
                                <label>Start time</label>
                                <input type="datetime-local" class="form-control" data-field="startDateTime" value="${toLocalDateTimeValue(record.startDateTime)}" />
                            </div>
                            <div class="form-group">
                                <label>Venue</label>
                                <input type="text" class="form-control" data-field="venue" value="${escapeHtml(record.venue)}" />
                            </div>
                            <div class="form-group">
                                <label>Home score</label>
                                <input type="number" min="0" class="form-control" data-field="homeScore" value="${record.homeScore}" />
                            </div>
                            <div class="form-group">
                                <label>Away score</label>
                                <input type="number" min="0" class="form-control" data-field="awayScore" value="${record.awayScore}" />
                            </div>
                        </div>
                        <div class="game-actions">
                            <button class="btn btn-primary btn-sm" data-action="save"><i data-lucide="save" class="icon-btn"></i> Save</button>
                            <button class="btn btn-danger btn-sm" data-action="delete"><i data-lucide="trash-2" class="icon-btn"></i> Delete</button>
                        </div>
                        <p class="text-muted text-sm mt-1">Updated ${escapeHtml(formatTimestamp(record.updatedAt))}</p>
                    </div>
                `;
            }).join('');

            refreshIcons();

            // Attach event listeners
            elements.gamesList.querySelectorAll('.game-card').forEach(card => {
                const id = card.dataset.id;

                card.querySelector('[data-action="save"]').addEventListener('click', async () => {
                    const payload = {
                        state: card.querySelector('[data-field="state"]').value,
                        startDateTime: card.querySelector('[data-field="startDateTime"]').value,
                        venue: card.querySelector('[data-field="venue"]').value,
                        homeScore: card.querySelector('[data-field="homeScore"]').value,
                        awayScore: card.querySelector('[data-field="awayScore"]').value
                    };
                    try {
                        await apiRequest(`/api/admin/games/${id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        await loadGames();
                        showToast('success', 'Game Updated', 'Changes saved successfully');
                        addActivity('game', 'Game updated');
                    } catch (error) {
                        showToast('error', 'Error', error.message);
                    }
                });

                card.querySelector('[data-action="delete"]').addEventListener('click', async () => {
                    if (!confirm('Delete this manual game?')) { return; }
                    try {
                        await apiRequest(`/api/admin/games/${id}`, { method: 'DELETE' });
                        await loadGames();
                        showToast('success', 'Game Deleted', 'Manual game removed');
                        addActivity('game', 'Game deleted');
                    } catch (error) {
                        showToast('error', 'Error', error.message);
                    }
                });
            });
        }

        // ============ Target Input Helpers ============
        const TARGET_PLACEHOLDERS = {
            tags: 'No ID needed (uses tags)',
            subscription: 'OneSignal subscription ID',
            player: 'OneSignal player ID',
            external: 'External user ID'
        };

        function updateTargetInput(select, input) {
            const type = select.value;
            input.placeholder = TARGET_PLACEHOLDERS[type] || 'Target ID';
            const shouldDisable = type === 'tags';
            input.disabled = shouldDisable;
            if (shouldDisable) { input.value = ''; }
        }

        function buildTargetPayload(type, id) {
            if (type === 'tags') { return {}; }
            const trimmed = id.trim();
            if (!trimmed) { throw new Error('Target ID is required for the selected target type.'); }
            if (type === 'subscription') { return { subscriptionId: trimmed }; }
            if (type === 'player') { return { playerId: trimmed }; }
            if (type === 'external') { return { externalUserId: trimmed }; }
            return {};
        }

        function parseNumericInput(value) {
            const trimmed = String(value || '').trim();
            if (!trimmed) { return null; }
            const parsed = Number(trimmed);
            return Number.isNaN(parsed) ? null : parsed;
        }

        // ============ Event Handlers ============
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => navigateToSection(item.dataset.section));
            });

            // Refresh all
            document.getElementById('refresh-all').addEventListener('click', async () => {
                await Promise.all([loadStatus({ showMessage: true }), loadPushStatus(), loadSports(), loadGames()]);
            });

            // Quick actions
            document.getElementById('quick-clear-cache').addEventListener('click', clearCache);
            document.getElementById('quick-run-notifier').addEventListener('click', runNotifierCheck);
            document.getElementById('quick-goal-check').addEventListener('click', runGoalCheck);
            document.getElementById('quick-biathlon-refresh').addEventListener('click', refreshBiathlon);

            // Status section
            document.getElementById('refresh-status').addEventListener('click', () => loadStatus({ showMessage: true }));

            // Cache section
            document.getElementById('clear-cache').addEventListener('click', clearCache);
            document.getElementById('refresh-cache-status').addEventListener('click', () => loadStatus({ showMessage: true }));

            // Sports section
            document.getElementById('refresh-sports').addEventListener('click', () => loadSports({ showMessage: true }));

            // Push section
            document.getElementById('refresh-push-status').addEventListener('click', () => loadPushStatus({ showMessage: true }));
            document.getElementById('run-goal-watcher').addEventListener('click', runGoalCheck);
            document.getElementById('send-test-push').addEventListener('click', sendTestPush);

            // Goal test
            document.getElementById('goal-test-sport').addEventListener('change', updateGoalTestTeamDropdowns);
            document.getElementById('send-goal-test').addEventListener('click', sendGoalTest);

            // Target type selects
            const testPushTargetType = document.getElementById('test-push-target-type');
            const testPushTargetId = document.getElementById('test-push-target-id');
            const goalTestTargetType = document.getElementById('goal-test-target-type');
            const goalTestTargetId = document.getElementById('goal-test-target-id');

            updateTargetInput(testPushTargetType, testPushTargetId);
            updateTargetInput(goalTestTargetType, goalTestTargetId);

            testPushTargetType.addEventListener('change', () => updateTargetInput(testPushTargetType, testPushTargetId));
            goalTestTargetType.addEventListener('change', () => {
                updateTargetInput(goalTestTargetType, goalTestTargetId);
                document.getElementById('goal-test-send-opposing').checked = goalTestTargetType.value === 'tags';
            });

            // Create game form
            document.getElementById('venue').addEventListener('input', () => { venueTouched = true; });
            document.getElementById('home-team').addEventListener('change', updateVenueFromHomeTeam);
            document.getElementById('create-game-form').addEventListener('submit', createGame);
        }

        async function clearCache() {
            try {
                await apiRequest('/api/cache/clear', { method: 'POST' });
                showToast('success', 'Caches Cleared', 'All caches have been cleared');
                addActivity('cache', 'All caches cleared');
                await loadStatus();
            } catch (error) {
                showToast('error', 'Error', error.message);
            }
        }

        async function runNotifierCheck() {
            try {
                const result = await apiRequest('/api/notifier/check', { method: 'POST' });
                showToast('success', 'Notifier Check', `Checked ${result.gamesChecked || 0} games`);
                addActivity('refresh', `Notifier checked ${result.gamesChecked || 0} games`);
                await loadStatus();
            } catch (error) {
                showToast('error', 'Error', error.message);
            }
        }

        async function runGoalCheck() {
            try {
                const result = await apiRequest('/api/goal-watcher/check', { method: 'POST' });
                const msg = result.newGoals?.length ? `Found ${result.newGoals.length} new goals` : 'No new goals';
                showToast('success', 'Goal Check', msg);
                addActivity('goal', msg);
                await loadPushStatus();
            } catch (error) {
                showToast('error', 'Error', error.message);
            }
        }

        async function refreshBiathlon() {
            try {
                const result = await apiRequest('/api/biathlon/refresh', { method: 'POST' });
                showToast('success', 'Biathlon Refreshed', `Loaded ${result.racesCount || 0} races`);
                addActivity('refresh', `Biathlon schedule refreshed (${result.racesCount || 0} races)`);
                await loadStatus();
            } catch (error) {
                showToast('error', 'Error', error.message);
            }
        }

        async function sendTestPush() {
            const btn = document.getElementById('send-test-push');
            btn.disabled = true;
            try {
                const message = document.getElementById('test-push-message').value.trim() || undefined;
                const targetPayload = buildTargetPayload(
                    document.getElementById('test-push-target-type').value,
                    document.getElementById('test-push-target-id').value
                );
                const result = await apiRequest('/api/notifications/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...(message ? { message } : {}), ...targetPayload })
                });
                showToast(result.success ? 'success' : 'error', 'Test Notification', result.success ? 'Notification sent!' : 'Failed to send');
                addActivity('notification', 'Test notification sent');
                await loadPushStatus();
            } catch (error) {
                showToast('error', 'Error', error.message);
            } finally {
                btn.disabled = false;
            }
        }

        async function sendGoalTest() {
            const btn = document.getElementById('send-goal-test');
            btn.disabled = true;
            try {
                const scoringTeamCode = document.getElementById('goal-test-scoring-team').value;
                const opposingTeamCode = document.getElementById('goal-test-opposing-team').value;

                if (!scoringTeamCode || !opposingTeamCode) {
                    throw new Error('Please select both teams.');
                }
                if (scoringTeamCode === opposingTeamCode) {
                    throw new Error('Teams must be different.');
                }

                const targetPayload = buildTargetPayload(
                    document.getElementById('goal-test-target-type').value,
                    document.getElementById('goal-test-target-id').value
                );

                const body = {
                    sport: document.getElementById('goal-test-sport').value,
                    scoringTeamCode,
                    opposingTeamCode,
                    scoringIsHome: document.getElementById('goal-test-scoring-home').checked,
                    homeScore: parseNumericInput(document.getElementById('goal-test-home-score').value),
                    awayScore: parseNumericInput(document.getElementById('goal-test-away-score').value),
                    period: document.getElementById('goal-test-period').value.trim() || undefined,
                    time: document.getElementById('goal-test-time').value.trim() || undefined,
                    scorerName: document.getElementById('goal-test-scorer-name').value.trim() || undefined,
                    sendOpposing: document.getElementById('goal-test-send-opposing').checked,
                    ...targetPayload
                };

                const result = await apiRequest('/api/notifications/goal-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                showToast(result.success ? 'success' : 'error', 'Goal Test', result.success ? 'Goal notification sent!' : 'Failed to send');
                addActivity('goal', `Goal test: ${scoringTeamCode} scored`);
                await loadPushStatus();
            } catch (error) {
                showToast('error', 'Error', error.message);
            } finally {
                btn.disabled = false;
            }
        }

        async function createGame(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button[type="submit"]');
            btn.disabled = true;

            const payload = {
                homeTeamCode: document.getElementById('home-team').value,
                awayTeamCode: document.getElementById('away-team').value,
                state: document.getElementById('game-state').value,
                startDateTime: document.getElementById('start-time').value,
                venue: document.getElementById('venue').value,
                homeScore: document.getElementById('home-score').value,
                awayScore: document.getElementById('away-score').value
            };

            if (payload.homeTeamCode === payload.awayTeamCode) {
                showToast('error', 'Error', 'Home and away teams must differ');
                btn.disabled = false;
                return;
            }

            try {
                await apiRequest('/api/admin/games', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                showToast('success', 'Game Created', 'Manual game created successfully');
                addActivity('game', `Game created: ${payload.homeTeamCode} vs ${payload.awayTeamCode}`);

                // Reset form
                document.getElementById('home-score').value = 0;
                document.getElementById('away-score').value = 0;
                document.getElementById('game-state').value = 'live';
                document.getElementById('start-time').value = toLocalDateTimeValue(new Date());
                venueTouched = false;
                updateVenueFromHomeTeam();

                await loadGames();
            } catch (error) {
                showToast('error', 'Error', error.message);
            } finally {
                btn.disabled = false;
            }
        }

        // ============ Initialize ============
        function refreshIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        async function init() {
            document.getElementById('start-time').value = toLocalDateTimeValue(new Date());

            // Initialize Lucide icons
            refreshIcons();

            setupEventListeners();
            initCharts();

            await Promise.all([
                loadTeams(),
                loadFootballTeams()
            ]);

            updateGoalTestTeamDropdowns();

            await Promise.all([
                loadStatus(),
                loadPushStatus(),
                loadSports(),
                loadGames()
            ]);

            addActivity('info', 'Admin console loaded');
            renderActivityLog();

            // Refresh icons after dynamic content is loaded
            refreshIcons();

            // Auto-refresh
            setInterval(() => loadStatus(), 15000);
            setInterval(() => loadPushStatus(), 15000);
        }

        init();
    </script>
</body>
</html>
