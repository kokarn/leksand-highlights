name: Require App Screenshots

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
      - reopened
      - ready_for_review

permissions:
  contents: read
  pull-requests: read

jobs:
  require-screenshots:
    name: Validate Cursor app screenshots
    if: startsWith(github.event.pull_request.head.ref, 'cursor/')
    runs-on: ubuntu-latest
    steps:
      - name: Enforce screenshot evidence for app changes
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                per_page: 100,
              }
            );

            const appFiles = files
              .map((file) => file.filename)
              .filter((filename) => filename.startsWith('shl-highlights-app/'));

            if (appFiles.length === 0) {
              core.info('No files under shl-highlights-app/ changed. Screenshot requirement skipped.');
              return;
            }

            const body = pr.body || '';

            const getSectionContent = (markdown, sectionName) => {
              const sectionRegex = new RegExp(
                `###\\s*${sectionName}\\b([\\s\\S]*?)(?=\\n###\\s+|\\n##\\s+|$)`,
                'i'
              );
              const match = markdown.match(sectionRegex);
              return match ? match[1] : '';
            };

            const collectImageUrls = (markdown) => {
              const markdownImageRegex = /!\[[^\]]*]\(([^)\s]+)(?:\s+"[^"]*")?\)/gi;
              const htmlImageRegex = /<img[^>]+src=["']([^"']+)["'][^>]*>/gi;
              const imageUrls = [];

              let markdownMatch = markdownImageRegex.exec(markdown);
              while (markdownMatch !== null) {
                imageUrls.push(markdownMatch[1]);
                markdownMatch = markdownImageRegex.exec(markdown);
              }

              let htmlMatch = htmlImageRegex.exec(markdown);
              while (htmlMatch !== null) {
                imageUrls.push(htmlMatch[1]);
                htmlMatch = htmlImageRegex.exec(markdown);
              }

              return imageUrls;
            };

            const disallowedImagePatterns = [
              /cursor\.com\/assets\/images\/open-in-/i,
            ];

            const isAllowedScreenshot = (imageUrl) => {
              return !disallowedImagePatterns.some((pattern) => pattern.test(imageUrl));
            };

            const desktopSectionContent = getSectionContent(body, 'Desktop');
            const mobileSectionContent = getSectionContent(body, 'Mobile');

            const desktopImageUrls = collectImageUrls(desktopSectionContent);
            const mobileImageUrls = collectImageUrls(mobileSectionContent);

            const desktopScreenshotUrls = desktopImageUrls.filter(isAllowedScreenshot);
            const mobileScreenshotUrls = mobileImageUrls.filter(isAllowedScreenshot);

            if (desktopScreenshotUrls.length === 0 || mobileScreenshotUrls.length === 0) {
              const changedPreview = appFiles.slice(0, 5).map((file) => `- ${file}`).join('\n');
              core.setFailed(
                [
                  'This Cursor Cloud PR changes `shl-highlights-app/**` and must include screenshots in the PR description.',
                  'Required:',
                  '1) At least one embedded image in the `### Desktop` section.',
                  '2) At least one embedded image in the `### Mobile` section.',
                  '3) Cursor footer badge images do not count as screenshots.',
                  '',
                  `Desktop section: ${desktopScreenshotUrls.length} valid image(s), ${desktopImageUrls.length} total image(s).`,
                  `Mobile section: ${mobileScreenshotUrls.length} valid image(s), ${mobileImageUrls.length} total image(s).`,
                  '',
                  'First changed app files:',
                  changedPreview || '- (none)',
                ].join('\n')
              );
              return;
            }

            core.info(
              `Screenshot requirement satisfied with ${desktopScreenshotUrls.length} desktop and ${mobileScreenshotUrls.length} mobile image(s).`
            );
